---
title: "JS函数的执行时机"
date: 2019-11-18T15:18:59+08:00
draft: false
---

**_版权声明：本文为周啟尧原创文章，著作权归本人和饥人谷所有，转载务必注明来源_**

**_---以下文档部分转载自知乎文章《从一道面试题-计时器函数谈闭包》，作者：胡桃夹子_**

[文章地址：https://zhuanlan.zhihu.com/p/80117819](https://zhuanlan.zhihu.com/p/80117819)

---

~~~JavaScript
/*********************/
let i = 0
for(i = 0; i<6; i++){
  setTimeout(()=>{
    console.log(i)
  },0)
}
/*********************/
~~~

上述代码会打印出6个6。

为什么不是0、1、2、3、4、5？

**原因是**

setTimeout是一个计时器，设置时间为0秒。（计时0秒，相当于是马上要执行）

setTimeout是从队列结束的时候开始计时的，如果前面的进程没有结束，那么要等到前面的进程结束后才开始计时。在这里的任务队列就是它自己所在的循环。

意思是，执行完当前的代码之后立即执行计时器中的代码。而上面的"当前代码"就是指for循环。

在for循环执行完毕后，此时的i值等于6，才轮到setTimeout异步执行箭头函数。

6个setTimeout打印出当前的i值，执行结果就是打印6个6。

**为了更好的理解，这里可以想象一个小场景。**

> for循环想让setTimeout打印点东西，他说：boss给了我个任务，这个i是我第一次执行的结果，你打印给boss看看呗。(此时i=0)  
> 
> setTimeout说：好的。然后他在便利贴上写道：打印i给老板看，放在了一边。（这里的i没有写明具体值）  
> 
> for循环执行完第二遍又来根setTimeout说：这个i是我第二次执行的结果，你打印给boss看看呗。(此时i=1)  
> 
> setTimeout又说：好的。然后他又在便利贴上写道：打印i给老板看，放在了第一张便利贴的下面。（这里的i没有写明具体值）    
> 
> 同样的情形发生了六次，在第六次的时候，for循环说：这个i是我的最终成果了，你打印一下。（i=6）  
> 
> for循环的工作结束了，想起之前for循环安排的工作都没干，于是它找回之前的便利贴，一张一张执行。
> 
> 每一张都写着"打印i",于是setTimeout直接把i打印了6遍给boss。



**怎样才能让上述代码打印出0、1、2、3、4、5？**

1. 利用闭包，用函数参数来保存i的值。

~~~JavaScript
let i = 0
for(i = 0; i<6; i++){
    !function(i){
        setTimeout(()=>{
            console.log(i)
        },0)
    }(i)
}
~~~

上述代码中，for循环每一次循环，都会把i的值作为参数传给循环内的立即执行函数，再由立即执行函数把i的值传给setTimeout执行。

setTimeout与立即执行函数构成了闭包。

setTimeout每一次得到的参数来自立即执行函数。而立即执行函数每一次接受的i值不同，因此传给setTimeout的i值不同。

同样也是6个setTimeout，但setTimeout打印的i值来自立即执行函数，因此打印出0、1、2、3、4、5。

> 对应上面的小场景。
> 
> 这里相当于是在for循环和setTimeout之间安插了一位记录员function。
> 
> for循环每一次执行的版本（i的具体值）都会给function记录下来。
> 
> 当setTimeout要执行的时候，会从function（而不是for循环）手中得到i的值。

上面的代码还可以写成：
~~~JavaScript
/*****************************/
let i = 0
for(i = 0; i<6; i++){
    setTimeout(!function(i){
            console.log(i)
  }(i),0)
}
/*****************************/
let i = 0
for(i = 0; i<6; i++){
    let a = function(v){
        console.log(v)
    }
    setTimeout(a(i),0)
}
/*****************************/
~~~

2. ES6的let块级作用域

~~~JavaScript
/*上面代码只要把 let = 1 写在for循环中就可以实现0~5的打印*/
for(let i = 0; i<6; i++){
  setTimeout(()=>{
    console.log(i)
  },0)
}
~~~

for循环头部的let声明会有个特殊的行为，这个行为指出变量在循环过程中不止被声明一次，每次迭代都会被声明。

随后的每个迭代都会使用上一个迭代结束时的值来初始化这个变量。

for循环头部的let不仅将i绑定到for循环的块中，事实上他将其重新绑定到了循环的每一个迭代中，确保使用上一个循环迭代结束时的值重新进行赋值。

---

**除了上述两种方法，还有的一些*其他的方法*以及对*闭包*的理解，之后待理解吸收后，再更新博客**
